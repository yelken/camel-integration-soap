:scrollbar:
:data-uri:
:toc2:

== Agile Integration for the Enterprise - for Instructors to setup the environment

This lab is for the instructor's preparation of the lab environment.
In this lab, review the business use case for this Agile Enterprise technical workshop. Next, proceed to set up the environment for the labs in this course.

.Lab Goals
* Set up the developer tools on all your student's desktop workstations
* Authenticate the OpenShift client with the OpenShift Container Platform master API
* Install and use the OpenShift command line interface (CLI)

.Lab Prerequisites
* An open broadband Internet connection
* A terminal client, such as PuTTy for Microsoft Windows
* A current browser, such as Google Chrome or Mozilla Firefox
* OPENTLC credentials
* Enough disk space to install Red Hat CodeReady Studio, Red Hat Fuse, Red Hat AMQ and other programming tools (Maven, OpenShift CLI, Java).
+
[IMPORTANT]
Make sure that the Internet connection is free of corporate proxies or other network rules that prevent access to remote servers on the Internet.


.Deployment

The following diagram shows the high level deployment topology in the OpenShift Container Platform cluster used in the lab.

.Deployment Topology
image::images/AI_Advanced_Deployment_dDagram.png[]


:numbered:

:scrollbar:
:data-uri:
:imagesdir: images
:toc2:



== Introduction

You will set up the student lab environment consisting of CodeReady Studio, a Red Hat OpenShift Container Platform cluster, common projects and middleware applications necessary for running the *Advanced Agile Integration lab*.

.Goal

* Provision an OpenShift Container Platform cluster to be used for the lab with the following applications:
** Red Hat 3scale API Management Multitenant Platform
** Red Hat 3scale Tenant API Managers and gateway
** Apicurito Studio
** Red Hat Fuse Online for each student user


== Deployment Architecture

The following diagram shows the high level deployment topology in the OpenShift Container Platform cluster.

.Deployment Topology
image::AI_Advanced_Deployment_dDagram.png[]

== Software Installation

=== OpenShift Container Platform Cluster:

. Provision an OCP cluster using the Ansible playbook located in this subdirectory *./ansible/* of this current directory.
. The resulting OCP cluster is a:
* Lab-specific cluster
* Seeded with user1-100 identities
* Hosting 3scale, AMQ, Fuse on OpenShift and Fuse Online.
+
. Create the following variables in each student workstation:
+
.Environment Variables:
|=======================
  | Variable | Value | Remarks
  | REGION | TBD | GUID of the server to be provided.
  | OCP_DOMAIN |  $REGION.openshift.opentlc.com |
  | PROJECT_NAME_3SCALE | 3scale-mt-opentlc-mgr | Project for deploying multi-tenant Red Hat 3scale API Management (User: opentlc-mgr)
  | PROJECT_NAME_API | apicurito | Project for deploying common instance of Apicurito Studio (User: opentlc-mgr)
  | PROJECT_NAME_IGNITE | userX-fuse-online | Project for each user's individual Red Hat Fuse Online instance
|=======================
+
NOTE: Cluster Quota for secrets and service accounts needs to be configured based on the number of projects running in the cluster. A rough estimate is calculated by the following formula: 9 x number of Projects + any custom secrets.


=== Application Deployments on OpenShift

. The following installations must be completed as the user `userX` on the OpenShift Container Platform cluster, where is X is the unique number assigned to your ID.

. Login to OpenShift Container Platform as user 'userX' with the provided password.
+
----
$ oc login https://${OPENSHIFT_MASTER} -u opentlc-mgr
----
+
. The following applications need to be deployed to the OpenShift Container Platform cluster. Login as `opentlc-mgr` (user with admin access) to deploy.

==== Red Hat 3scale (Multi-tenant):

. Install a Red Hat 3scale Multi-tenant environment using this link:https://github.com/honghuac/rhsummit_ansible/tree/master/ansible/3scale_multitenant[Ansible Playbook]

. Examine the Ansible Playbook template
.. Note that it installs with multi-tenant deployment & creating tenants.
.. Each user gets own tenant for setting up APIs and the Red Hat 3scale Developer Portal.
.. The Red Hat 3scale API Management Platform is integrated with the Red Hat 3scale Developer Portal, using Red Hat SSO with OpenShift identity management.


==== Red Hat Fuse Online

. This can be installed using this link:https://github.com/honghuac/rhsummit_ansible/tree/master/ansible/fuse_online[Fuse Online Ansible Playbook]

. Install as many instances of Fuse Online as there are students (one per student)

. Examine the Ansible Playbook template
.. Note that it installs without multi-tenancy.
.. Each installation involves the use of a Syndesis operator that manages the installation.
.. In addition to the Fuse Online application pods, an AMQ Broker and a PHP app called `Todo` are also installed.


==== Red Hat Fuse On OpenShift and AMQ Online

. Import the Red Hat Fuse images and templates to the OpenShift Container Platform cluster, using this https://github.com/honghuac/rhsummit_ansible/tree/master/ansible/amq_fuse_templates_is[Ansible Playbook].
+
NOTE: The image streams available in the above template will need to be downloaded from `https://registry.redhat.io` which needs login access. Use the template created here instead: link:https://raw.githubusercontent.com/honghuac/rhsummit_ansible/master/json/fis-image-streams.json[https://raw.githubusercontent.com/honghuac/rhsummit_ansible/master/json/fis-image-streams.json].


== Install Required Software on Student Workstations

In this setup lab, you create Red Hat Fuse on OpenShift applications, using Red Hat CodeReady Studio and OpenShift CLI tools on the desktop, and deploy them to an OpenShift project.

. Install the software listed here on your local machine:

* link:http://www.oracle.com/technetwork/java/javase/downloads/index.html[Java SE^] (version 1.8)
* link:http://maven.apache.org[Apache Maven^] (version 3.3.9+)
* link:https://git-scm.com/downloads[Git^] (latest version)
* link:https://access.redhat.com/downloads/content/290/ver=3.9/rhel---7/3.9.25/x86_64/product-software[OpenShift CLI client^] (version 3.11)
* (Optional) link:https://www.soapui.org/downloads/soapui.html[SoapUI^] (latest version)



== Install Red Hat CodeReady Studio on student workstations

Red Hat CodeReady Studio is an integrated development environment (IDE) that combines both tooling and runtime components, including Eclipse plug-ins, best-of-breed open source tools, and the Red Hat(R) JBoss(R) Enterprise Application Platform (JBoss EAP).

To complete the labs in the course, you must have Red Hat CodeReady Studio installed in your local student development workstations. Students use Red Hat CodeReady Studio to design Apache Camel routes.

=== Install Red Hat CodeReady Studio v12.9.0

. Using your browser, navigate to the product page for link:https://developers.redhat.com/products/codeready-studio/download/[Red Hat CodeReady Studio^].

. On the left side, click *Download*.
* Note that the latest release of Red Hat CodeReady Studio is highlighted near the top of the page.

. Click *Installer* to download the installer for version 12.11 of Red Hat CodeReady Studio.

. Proceed to log in.
* The download begins shortly after you log in.

. Follow the onscreen instructions to install Red Hat CodeReady Studio, substituting the name of the JAR file with the one you downloaded:

[NOTE]
The installation guide is also available on the link:https://access.redhat.com/documentation/en-us/red_hat_developer_studio/[Red Hat CodeReady Studio Product Documentation^] page, where you can select the version you are using.

=== Install Red Hat CodeReady Studio Integration Stack Plug-ins

Red Hat CodeReady Studio includes a variety of plug-ins for Eclipse. You use the following Red Hat CodeReady Studio plug-ins to complete the labs in the Red Hat OPEN middleware courses:

* *Integration Stack*: The Integration Stack suite of plug-ins is particularly important when using Red Hat(R) Fuse and Red Hat(R) AMQ. The Integration Stack is included with Red Hat CodeReady Studio.

* *EGit*: Red Hat CodeReady Studio includes the Eclipse EGit plug-in, which provides Git project support. No additional installation is required. Git is an open source version control system, providing developers with fast, versatile access to their application code's entire revision history.

* *M2E*: Red Hat CodeReady Studio includes the Eclipse M2E plug-in, which provides support for Apache Maven projects. No additional installation is required. The M2E plug-in enables you to edit a Maven projectâ€™s `pom.xml` and run a Maven build from the IDE.

You can select the plug-in installation during the Red Hat CodeReady Studio installation process, or you can select these from the welcome page.

== Obtain Course Lab Assets (Instructor to guide student on this during labs)

This course comes with a variety of lab assets that are version controlled in GitHub. In this section, you clone or update the lab assets on your desktop so that they are available locally for use in the course's other labs.

=== Clone Lab Project from Git

. In a terminal shell, perform the following commands:
+
[source,text]
-----
$ cd $HOME
$ git clone https://gitlab.com/redhatsummitlabs/agile-integration-for-the-enterprise.git
$ cd agile-integration-for-the-enterprise
$ git checkout development
$ cd code
-----
+
[NOTE]
`$HOME/agile-integration-for-the-enterprise` is the root folder containing lab assets and lab sheets. The absolute path to this folder is referred to as `$AI_EXERCISE_HOME` in the instructions.
The subdirectory named `$AI_EXERCISE_HOME/code` contains the lab assets used in the individual labs.


=== Access lab sheets and lab assets

. Familiarize yourselves with the instructor lab assets in `$AI_EXERCISE_HOME/instructor-only`
. Familiarize yourselves with the student lab sheets in `$AI_EXERCISE_HOME/
. Familiarize yourselves with the lab assets in `$AI_EXERCISE_HOME/code`


== Deploy AMQ Broker on OpenShift Container Platform

We need to deploy AMQ 7 broker on OpenShift Container Platform. The general installation steps are documented here: link:https://access.redhat.com/documentation/en-us/red_hat_amq/7.2/html-single/deploying_amq_broker_on_openshift_container_platform/[AMQ Installation of OpenShift Guide].

. In the terminal, log in to the OpenShift Container Platform cluster.
. Switch OpenShift project:
+
----
$ oc project $OCP_PROJECT_PREFIX-fuse
----

. Add the *view* role to the service account:
+
----
$ echo '{"kind": "ServiceAccount", "apiVersion": "v1", "metadata": {"name": "amq-service-account"}}' | oc create -f -
$ oc policy add-role-to-user view system:serviceaccount:$OCP_PROJECT_PREFIX-fuse:amq-service-account
----

. Deploy the broker:
+
----
$ oc new-app --namespace $OCP_PROJECT_PREFIX-fuse \
   --template=amq-broker-72-basic \
   -p=AMQ_PROTOCOL=openwire,amqp,stomp,mqtt,hornetq \
   -p=AMQ_USER=admin \
   -p=AMQ_PASSWORD=password
----

. Check that the broker pod is running.
. Make a note of the console URL. You can access the console URL from a web browser and ensure the broker is started correctly.
. The broker service url for AMQP would be `broker-amq-amqp:5672`. Make a note of this when configuring the AMQ connection for the labs.

== Deploy PostgreSQL on OpenShift Container Platform

We need to deploy PostgreSQL database on OpenShift Container Platform. The general installation steps are documented here: link:https://docs.openshift.com/container-platform/3.10/using_images/db_images/postgresql.html[PostgreSQL on OpenShift guide].

. In the terminal, log in to the OpenShift Container Platform cluster.
. Switch OpenShift project:
+
----
$ oc project $OCP_PROJECT_PREFIX-fuse
----

. Deploy the database:
+
----
$ oc new-app --namespace $OCP_PROJECT_PREFIX-fuse \
    -p POSTGRESQL_USER=postgres \
    -p POSTGRESQL_PASSWORD=postgres \
    -p POSTGRESQL_DATABASE=sampledb \
    postgresql-persistent
----

. Check that the database pod is running.
. Identify the name of the pod running PostgreSQL and open a remote shell to the pod:
+
----
$  oc get pods | grep postgresql
$  oc rsh <pod>
----

. Log in to PostgreSQL and create the *sampledb* database.
+
----
sh-4.2$ createdb -h localhost -p 5432 -U postgres sampledb
sh-4.2$ PGPASSWORD=$POSTGRESQL_PASSWORD psql -h postgresql $POSTGRESQL_DATABASE $POSTGRESQL_USER
psql (9.6.10)
Type "help" for help.

sampledb=#

----

. Create the tables.
+
Run the following commands on the PostgreSQL command line:
+
----
CREATE SCHEMA USECASE;
CREATE TABLE USECASE.T_ACCOUNT (
    id  SERIAL PRIMARY KEY,
    CLIENT_ID integer,
    SALES_CONTACT VARCHAR(30),
    COMPANY_NAME VARCHAR(50),
    COMPANY_GEO CHAR(20) ,
    COMPANY_ACTIVE BOOLEAN,
    CONTACT_FIRST_NAME VARCHAR(35),
    CONTACT_LAST_NAME VARCHAR(35),
    CONTACT_ADDRESS VARCHAR(255),
    CONTACT_CITY VARCHAR(40),
    CONTACT_STATE VARCHAR(40),
    CONTACT_ZIP VARCHAR(10),
    CONTACT_EMAIL VARCHAR(60),
    CONTACT_PHONE VARCHAR(35),
    CREATION_DATE TIMESTAMP,
    CREATION_USER VARCHAR(255)
);
CREATE TABLE USECASE.T_ERROR (
    ID SERIAL PRIMARY KEY,
    ERROR_CODE VARCHAR(4) NOT NULL,
    ERROR_MESSAGE VARCHAR(255),
    MESSAGE VARCHAR(512),
    STATUS CHAR(6)
);
----
+
NOTE: You can use `\q` to exit the PostgreSQL command line.

== Useful SQL Scripts

----

INSERT INTO USECASE.T_ACCOUNT (CLIENT_ID,SALES_CONTACT,COMPANY_NAME,COMPANY_GEO,COMPANY_ACTIVE,CONTACT_FIRST_NAME,CONTACT_LAST_NAME,CONTACT_ADDRESS,CONTACT_CITY,CONTACT_STATE,CONTACT_ZIP,CONTACT_PHONE,CREATION_DATE,CREATION_USER) VALUES ('95','Rachel Cassidy','MountainBikers','SOUTH_AMERICA',true,'George','Jungle','1101 Smith St.','Raleigh','NC','27519','919-555-0800','2015-12-15','fuse_usecase');

DELETE FROM USECASE.T_ACCOUNT;

SELECT * FROM USECASE.T_ACCOUNT;

----

== Install Red Hat AMQ 7.2.0

You need to run a Red Hat AMQ broker locally to execute some of the labs in this course. Please download the link:https://developers.redhat.com/products/amq/download/[Red Hat AMQ 7.2.0 Broker installer] and follow the link:https://access.redhat.com/documentation/en-us/red_hat_amq/7.2/html/using_amq_broker/installation[instructions] to install it on your laptop.

Once installed, please follow the link:https://access.redhat.com/documentation/en-us/red_hat_amq/7.2/html/using_amq_broker/getting_started[Getting Started] steps to start a new broker running locally on your laptop.

IMPORTANT: Provide the user ID and password for the broker as `admin` and `password`.

*Congratulations, you have completed this lab.*
