:scrollbar:
:data-uri:
:toc2:
:linkattrs:

= Lab 2d. Legacy Application Wrapper

Now, you develop a Camel route to migrate legacy SOAP services to provide a REST API wrapper using Camel.

SOAP-based services are plentiful in many enterprise solutions and are slowly being replaced by RESTful services to simplify their use. A new wizard is available in the latest version of Red Hat Fuse Tooling to help you make the transition with Apache Camel’s Rest DSL. This lab shows how to use the new wizard to transition from older SOAP-based services to more modern REST-based services.

.Goals in this section
* Create REST API for the Customer SOAP service from previous lab.
* Design Apache Camel route that exposes REST API consuming JSON.
* Use the Red Hat Fuse Tooling in Red Hat Developer Studio to create *wsdl2rest* mapping.
* Deploy and test the solution.


==== Import the *legacy-soap-rest-wrapper* Project into CodeReady Studio

. Using the same method you used in the previous lab, import the `legacy-soap-rest-wrapper` project into your CodeReady Studio workspace. Using the Wizard, you will find 1 project:

* legacy-soap-rest-wrapper

*This project contains the Legacy SOAP Wrapper REST service that will route and transform REST service requests and responses to and from the existing backend SOAP service.*

The SOAP Web Service *soap-cxfws-service* which you have earlier deployed, is used as the backend SOAP service for this part of the lab. This service is developed using CXF-WS, and deployed on Karaf. The service is running on Red Hat Fuse 6.3. Make sure the SOAP service is deployed to OpenShift Container Platform and the WSDL is accessible at the URL: link:http://$soap-cxfws-service-route/ws/customerService?wsdl[http://$soap-cxfws-service-route/ws/customerService?wsdl].


==== Create the Camel Route for SOAP service migration

. Right-click the *legacy-soap-rest-wrapper* in the Red Hat Fuse Integration perspective and select *New->Camel Rest DSL from WSDL*, or click *File->New->Other…, Red Hat Fuse->Camel Rest DSL from WSDL*.
. Provide the URL to soap-cxfws-service WSDL and ensure the *legacy-soap-rest-wrapper* project is selected:
+
image::images/legacy-soap-wsdl-import.png[]

. Click *Next*.
. Keep the default values of fields unchanged and click *Finish*.
+
image::images/legacy-soap-wsdl-import-2.png[]

. Now you should see the Java classes and the Spring context XML *rest-springboot-context.xml*.
+
image::images/legacy-soap-wsdl-import-3.png[]

. Inspect the Camel route and notice that the solution is code-complete and ready to run.


==== Run the Legacy SOAP Wrapper REST service Locally

. To run the Legacy SOAP Wrapper REST service locally, run the following Maven command from the `$AI_EXERCISE_HOME/code/fuse/legacy-soap-rest-wrapper/` directory:
+
----
$ mvn spring-boot:run -Dfabric8.skip
----
+
. The Camel service, that has just launched, should be running on port 8080, and can be accessed through URL: link:http://localhost:8080/api/jaxrs/account[http://localhost:8080/api/jaxrs/account].
. Send a test request to the Legacy SOAP Wrapper REST service and check if the backend service is invoked correctly:
+
----
$ curl -k http://localhost:8080/api/jaxrs/account -X PUT  -d '{"company":{"name":"Rotobots","geo":"NA","active":true},"contact":{"firstName":"Bill","lastName":"Smith","streetAddr":"100 N Park Ave.","city":"Phoenix","state":"AZ","zip":"85017","phone":"602-555-1100"}}' -H 'content-type: application/json'
----

. The response should be as below:
+
----
{"company":{"active":true,"geo":"NA","name":"Rotobots"},"contact":{"city":"Phoenix","firstName":"Bill","lastName":"Smith","phone":"602-555-1100","state":"AZ","streetAddr":"100 N Park Ave.","zip":"85017"},"id":33,"salesContact":"Bernard Tison"}
----
+
. From the test results, validate that the data currently in the PostgreSQL database was retrieved successfully via the Legacy SOAP Wrapper Rest service .



==== Deploy to OpenShift Container Platform


. To deploy the application to OpenShift Container Platform, execute the following Maven command from the terminal:
+
----
$ mvn fabric8:deploy
----

. Check that the project is deployed successfully. A Kubernetes pod for the deployment *legacy-soap-rest-wrapper* should be started.

. Take note of the route name of the *legacy-soap-rest-wrapper* service, which is now exposed to external traffic:
+
----
$ oc get routes -n business-services | grep legacy-soap
NAME                       HOST/PORT                                                                       PATH      SERVICES                   PORT      TERMINATION   WILDCARD
legacy-soap-rest-wrapper   legacy-soap-rest-wrapper-legacy-soap.apps.cluster-490c.sandbox693.opentlc.com             legacy-soap-rest-wrapper   8080                    None
----
+
. Repeat the SOAP service test by updating the CURL command, replacing the hostname with the OpenShift service route name for the *legacy-soap-rest-wrapper* hosted on OpenShift Container Platform:
+
----
$ curl -k http://legacy-soap-rest-wrapper-legacy-soap.apps.cluster-490c.sandbox693.opentlc.com/api/jaxrs/account -X PUT  -d '{"company":{"name":"Rotobots","geo":"NA","active":true},"contact":{"firstName":"Bill","lastName":"Smith","streetAddr":"100 N Park Ave.","city":"Phoenix","state":"AZ","zip":"85017","phone":"602-555-1100"}}' -H 'content-type: application/json'
----
+
. Validate that the same REST response was received, as in the previous test.

*Congratulations, you have completed each of the modules of this lab.*

[.text-center]
image:images/icons/icon-previous.png[align=left, width=128, link=2c_Integration_Application.adoc] image:images/icons/icon-home.png[align="center",width=128, link=README.adoc] image:images/icons/icon-next.png[align="right"width=128, link=3_Fuse_Online_Enrich_Lab.adoc]